<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Mitch's Admin</title>
  
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  
  <script type="text/javascript">
    (function(){ emailjs.init("X_5xpqldnPZM4GwJh"); })();
  </script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
    body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
    .animate-in { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body class="bg-stone-50 text-stone-900 pb-20 select-none">

<div id="main-view"></div>
<div id="toast-layer" class="fixed top-4 left-4 right-4 z-[60] pointer-events-none"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
  import { getFirestore, collection, onSnapshot, doc, updateDoc, deleteDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
  import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-messaging.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCMcxuH-8Pc0t8eC71xOU8TXLu0ZoF-RG4",
    authDomain: "mitches-coffee.firebaseapp.com",
    projectId: "mitches-coffee",
    storageBucket: "mitches-coffee.firebasestorage.app",
    messagingSenderId: "789709713646",
    appId: "1:789709713646:web:3f09ce026b40a85b3f03ff"
  };

  const VAPID_KEY = "BF3iJzRgdCJq3LAFW2c05_5m-dGyzGhS74-_G4ty609IzftV92_inFfBP9ThuDAZ7FJd2V27VvNFgJsyOk8lzg4";
  const appId = "mitchs-coffee";
  const ADMIN_CODE = "222";
  
  // Email/SMS Config
  const EMAIL_SERVICE_ID = "service_m3qf2td";
  const EMAIL_TEMPLATE_ID = "template_c7bbquk"; 
  const CARRIERS = { "Verizon": "@vtext.com", "AT&T": "@txt.att.net", "T-Mobile": "@tmomail.net", "Sprint": "@messaging.sprintpcs.com", "None": "" };

  let db, auth, messaging;
  let state = {
    isAdminAuth: false, orders: [], lastId: null,
    settings: { deliveryEnabled: true, shopOpen: true },
    fcmToken: null
  };

  async function init() {
    const app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    auth = getAuth(app);
    messaging = getMessaging(app);

    if ('serviceWorker' in navigator) {
       try { await navigator.serviceWorker.register('sw.js'); } catch (err) {}
    }

    if (localStorage.getItem('mitch_admin_auth') === 'true') state.isAdminAuth = true;

    await signInAnonymously(auth);
    listenOrders();
    listenSettings();
    
    // Request permission immediately if logged in
    if(state.isAdminAuth && Notification.permission === 'granted') requestPushPermission();

    onMessage(messaging, (payload) => {
        showToast(payload.notification.title + ": " + payload.notification.body);
    });
    
    render();
  }

  window.requestPushPermission = async () => {
    try {
        const token = await getToken(messaging, { vapidKey: VAPID_KEY });
        if (token) { state.fcmToken = token; render(); }
    } catch (err) { console.log(err); }
  };

  function listenOrders() {
    onSnapshot(collection(db, "artifacts", appId, "public", "data", "orders"), snap => {
      state.orders = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
      // Simple beep for new orders while app is open
      if(state.isAdminAuth && state.orders.length > 0) {
        const latest = state.orders[0];
        if(latest.status === 'pending' && state.lastId !== latest.id) {
            state.lastId = latest.id;
            const audio = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3'); // Simple ding
            audio.play().catch(e=>console.log("Audio play failed"));
            showToast(`New Order: ${latest.customerName}`);
        }
      }
      render();
    });
  }

  function listenSettings() {
      const docRef = doc(db, "artifacts", appId, "public", "data", "settings", "global");
      onSnapshot(docRef, (docSnap) => {
          if (docSnap.exists()) { state.settings = docSnap.data(); render(); } 
          else { setDoc(docRef, { deliveryEnabled: true, shopOpen: true }); }
      });
  }

  function sendNotifyToStudent(order) {
    const message = `Hey ${order.customerName}, your Mitch's Coffee order is READY! Come to room 101.`;
    const fromName = "Mitch's Coffee";
    const replyTo = "noreply@mitchscoffee.com";

    if (order.customerPhone && order.customerCarrier && order.customerCarrier !== 'None') {
        const smsGateway = order.customerPhone + CARRIERS[order.customerCarrier];
        emailjs.send(EMAIL_SERVICE_ID, EMAIL_TEMPLATE_ID, { to_email: smsGateway, name: fromName, email: replyTo, message: message }).catch(err => console.log("SMS Failed"));
    }
    if (order.customerEmail && order.customerEmail.includes('@')) {
        emailjs.send(EMAIL_SERVICE_ID, EMAIL_TEMPLATE_ID, { to_email: order.customerEmail, name: fromName, email: replyTo, message: message }).catch(err => console.log("Email Failed"));
    }
  }

  window.adminAuth = e => { e.preventDefault(); if (document.getElementById("adminPin").value === ADMIN_CODE) { state.isAdminAuth = true; localStorage.setItem('mitch_admin_auth', 'true'); requestPushPermission(); render(); } else { showToast("Wrong Code!"); } };
  window.adminLock = () => { state.isAdminAuth = false; localStorage.removeItem('mitch_admin_auth'); render(); };
  
  window.toggleDeliverySetting = () => { setDoc(doc(db, "artifacts", appId, "public", "data", "settings", "global"), { deliveryEnabled: !state.settings.deliveryEnabled }, { merge: true }); };
  window.toggleShopOpen = () => { setDoc(doc(db, "artifacts", appId, "public", "data", "settings", "global"), { shopOpen: !state.settings.shopOpen }, { merge: true }); };
  
  window.setStatus = (id, s) => { updateDoc(doc(db,"artifacts",appId,"public","data","orders",id), { status: s }); if (s === 'ready') { const order = state.orders.find(o => o.id === id); if (order) sendNotifyToStudent(order); } };
  window.deleteOrder = id => deleteDoc(doc(db,"artifacts",appId,"public","data","orders",id));
  window.restartApp = () => { location.reload(); };
  
  function showToast(m) { const t = document.getElementById("toast-layer"); t.innerHTML = `<div class="animate-bounce bg-stone-900 text-white px-6 py-3 rounded-2xl shadow-2xl text-center font-bold border border-white/10 mx-auto max-w-xs">${m}</div>`; setTimeout(() => { t.innerHTML = ''; }, 3000); }

  function render() {
    const root = document.getElementById("main-view");
    if(!state.isAdminAuth) {
        root.innerHTML = `
            <div class="min-h-screen bg-stone-100 flex items-center justify-center p-4">
                <div class="bg-white p-8 rounded-3xl border shadow-2xl text-center space-y-6 animate-in w-full max-w-sm">
                    <div class="bg-stone-100 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto border-2 border-stone-200"><i data-lucide="lock" class="text-stone-400"></i></div>
                    <div><h1 class="text-2xl font-black italic">Mitch Only</h1><p class="text-stone-500 text-sm">Enter pin to see orders</p></div>
                    <form onsubmit="adminAuth(event)" class="space-y-4">
                        <input type="password" id="adminPin" placeholder="PIN" class="w-full bg-stone-50 border-2 rounded-2xl px-4 py-4 text-center text-2xl font-black tracking-[1em] outline-none focus:border-stone-900">
                        <button class="w-full bg-stone-900 text-white py-4 rounded-2xl font-bold text-lg shadow-xl">Open Queue</button>
                    </form>
                </div>
            </div>`;
    } else {
        root.innerHTML = `
            <header class="bg-stone-900 text-white p-4 sticky top-0 z-50 shadow-lg">
                <div class="max-w-md mx-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-black italic">Admin Panel</h2>
                        <button onclick="adminLock()" class="text-[10px] font-bold border border-white/20 px-3 py-1 rounded-lg uppercase">Lock</button>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <div class="bg-white/10 p-2 rounded-xl flex flex-col items-center justify-center gap-1">
                            <span class="text-[10px] font-bold uppercase text-stone-400">Shop</span>
                            <button onclick="toggleShopOpen()" class="w-full py-1.5 rounded-lg font-black text-xs uppercase transition-colors ${state.settings.shopOpen ? 'bg-green-500 text-white' : 'bg-red-500 text-white'}">${state.settings.shopOpen ? 'OPEN' : 'AWAY'}</button>
                        </div>
                        <div class="bg-white/10 p-2 rounded-xl flex flex-col items-center justify-center gap-1">
                            <span class="text-[10px] font-bold uppercase text-stone-400">Delivery</span>
                            <button onclick="toggleDeliverySetting()" class="w-full py-1.5 rounded-lg font-black text-xs uppercase transition-colors ${state.settings.deliveryEnabled ? 'bg-blue-600 text-white' : 'bg-stone-600 text-stone-400'}">${state.settings.deliveryEnabled ? 'ON' : 'OFF'}</button>
                        </div>
                    </div>
                    <button onclick="requestPushPermission()" class="w-full mt-2 bg-blue-600 py-2 text-[10px] uppercase font-bold text-white rounded-lg transition hover:bg-blue-500">
                        ${state.fcmToken ? 'ALERTS ENABLED' : 'ENABLE ALERTS'}
                    </button>
                </div>
            </header>
            
            <main class="max-w-md mx-auto p-4 space-y-4 pb-20">
                ${state.orders.length === 0 ? '<p class="text-center py-20 text-stone-400 font-bold italic">No orders yet, Mitch!</p>' : ''}
                <div class="grid grid-cols-2 gap-3">
                    ${state.orders.map(o => `
                    <div class="bg-white p-3 rounded-[1.5rem] border-2 shadow-sm transition-all ${o.status==='completed'?'opacity-40 border-stone-100':'border-brand shadow-lg'} flex flex-col justify-between">
                        <div>
                            <div class="flex justify-between items-start mb-2">
                                <div class="overflow-hidden">
                                    <h3 class="font-black text-sm truncate leading-tight">${o.customerName}</h3>
                                    ${o.isDelivery ? `<span class="bg-blue-600 text-white text-[8px] font-black px-1.5 py-0.5 rounded uppercase block w-fit mt-1">DELIVERY Rm ${o.dormRoom}</span>` : `<span class="bg-stone-200 text-stone-700 text-[8px] font-black px-1.5 py-0.5 rounded uppercase block w-fit mt-1">PICKUP</span>`}
                                </div>
                                <button onclick="deleteOrder('${o.id}')" class="text-stone-300 hover:text-red-500 p-0.5"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                            </div>
                            <div class="space-y-1 mb-3 text-[10px] leading-tight text-stone-600">
                                ${o.items.map(it => `<div class="border-b border-stone-100 pb-1 last:border-0"><span class="font-bold text-stone-900">${it.qty}x ${it.name.split(' ').slice(0,2).join(' ')}</span><div class="text-[9px] text-stone-400">${it.size} ${it.type==='drink' && it.syrupType!=='None' ? `+ ${it.syrupPumps}p ${it.syrupType}` : ''}</div></div>`).join('')}
                            </div>
                        </div>
                        <div class="flex flex-col gap-1 mt-auto">
                            ${o.status === 'pending' ? `<button onclick="setStatus('${o.id}', 'brewing')" class="w-full bg-brand text-white py-2 rounded-xl font-black text-xs active:scale-95">Brew</button>` : ''}
                            ${o.status === 'brewing' ? `<button onclick="setStatus('${o.id}', 'ready')" class="w-full bg-green-600 text-white py-2 rounded-xl font-black text-xs active:scale-95">Ready</button>` : ''}
                            ${o.status === 'ready' ? `<button onclick="setStatus('${o.id}', 'completed')" class="w-full bg-stone-900 text-white py-2 rounded-xl font-black text-xs active:scale-95">Done</button>` : ''}
                            <div class="text-[8px] font-black text-center text-stone-300 uppercase tracking-widest mt-1">${o.status}</div>
                        </div>
                    </div>`).join('')}
                </div>
            </main>`;
    }
    lucide.createIcons();
  }

  init();
</script>
</body>
</html>
