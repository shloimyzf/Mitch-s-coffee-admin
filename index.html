<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mitch's Coffee</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
    body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
    .animate-in { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .pulse-amber { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
  </style>
</head>
<body class="bg-stone-50 text-stone-900 pb-20">

<div id="app">
  <div class="min-h-screen flex flex-col items-center justify-center gap-4">
    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-amber-600"></div>
    <p class="text-stone-400 text-sm font-medium">Connecting to Mitch's Coffee...</p>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

  /* ================= BACKEND CONFIG ================= */
  const firebaseConfig = {
    apiKey: "AIzaSyCMcxuH-8Pc0t8eC71xOU8TXLu0ZoF-RG4",
    authDomain: "mitches-coffee.firebaseapp.com",
    projectId: "mitches-coffee",
    storageBucket: "mitches-coffee.firebasestorage.app",
    messagingSenderId: "789709713646",
    appId: "1:789709713646:web:3f09ce026b40a85b3f03ff"
  };

  const appId = "mitchs-coffee";
  const ADMIN_CODE = "222";

  /* ================= STATE ================= */
  let db, auth;
  let state = {
    user: null,
    isLoggedIn: false,
    view: "customer",
    isAdminAuth: false,
    adminInput: "",
    customerName: "",
    dormRoom: "",
    orders: [],
    cart: [],
    selectedSize: 'Small',
    syrupType: 'None',
    syrupPumps: 0,
    isDelivery: false,
    notification: null,
    lastId: null
  };

  const MENU_ITEMS = [
    { id: 'hot-latte', name: 'Regular Hot Latte', category: 'Lattes', type: 'drink' },
    { id: 'iced-latte', name: 'Iced Latte', category: 'Lattes', type: 'drink' },
    { id: 'vanilla-hot-latte', name: 'Vanilla Hot Latte', category: 'Lattes', type: 'drink' },
    { id: 'vanilla-iced-latte', name: 'Vanilla Iced Latte', category: 'Lattes', type: 'drink' },
    { id: 'hot-cocoa', name: 'Regular Hot Cocoa', category: 'Hot Cocoa', type: 'drink' },
    { id: 'choc-chip', name: 'Chocolate Chip Cookie', category: 'Cookies', type: 'cookie' },
  ];

  const CATEGORIES = ['Lattes', 'Hot Cocoa', 'Cookies'];

  /* ================= CORE LOGIC ================= */

  async function init() {
    const app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    auth = getAuth(app);
    await signInAnonymously(auth);
    onAuthStateChanged(auth, user => {
      state.user = user;
      if (user) listenOrders();
      render();
    });
  }

  function listenOrders() {
    const ref = collection(db, "artifacts", appId, "public", "data", "orders");
    onSnapshot(ref, snap => {
      state.orders = snap.docs
        .map(d => ({ id: d.id, ...d.data() }))
        .sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
      
      if(state.view === 'admin' && state.isAdminAuth && state.orders.length > 0) {
        const latest = state.orders[0];
        if(latest.status === 'pending' && state.lastId !== latest.id) {
            state.lastId = latest.id;
            showToast(`New Order from ${latest.customerName}!`);
        }
      }
      render();
    });
  }

  /* ================= ACTIONS ================= */

  window.login = e => {
    e.preventDefault();
    const val = document.getElementById("loginName").value.trim();
    if (val) { state.customerName = val; state.isLoggedIn = true; render(); }
  };

  window.setView = v => { state.view = v; render(); };
  window.setSize = s => { state.selectedSize = s; if (state.syrupType !== 'None') state.syrupPumps = s === 'Small' ? 3 : 4; render(); };
  window.setSyrup = t => { state.syrupType = t; state.syrupPumps = t === 'None' ? 0 : (state.selectedSize === 'Small' ? 3 : 4); render(); };
  window.changePumps = d => { state.syrupPumps = Math.max(0, Math.min(6, state.syrupPumps + d)); render(); };
  window.setDelivery = v => { state.isDelivery = v; render(); };

  window.add = id => {
    const item = MENU_ITEMS.find(m => m.id === id);
    const size = item.type === 'drink' ? state.selectedSize : 'N/A';
    const price = item.type === 'drink' ? (size === 'Small' ? 5 : 6) : 1;
    const existing = state.cart.find(c => c.id === id && c.size === size && c.syrupType === state.syrupType && c.syrupPumps === state.syrupPumps);
    if (existing) existing.qty++;
    else state.cart.push({ ...item, size, price, syrupType: state.syrupType, syrupPumps: state.syrupPumps, qty: 1 });
    render();
  };

  window.removeCart = idx => { if (state.cart[idx].qty > 1) state.cart[idx].qty--; else state.cart.splice(idx, 1); render(); };

  window.order = async () => {
    const room = document.getElementById("roomInput")?.value.trim();
    if(!room || !state.cart.length) return showToast("Room # required!");
    const sub = state.cart.reduce((s, i) => s + (i.price * i.qty), 0);
    const total = sub + (state.isDelivery ? 1 : 0);
    try {
      await addDoc(collection(db, "artifacts", appId, "public", "data", "orders"), {
        customerName: state.customerName, dormRoom: room, items: state.cart, total,
        isDelivery: state.isDelivery, status: "pending", timestamp: serverTimestamp(), userId: state.user.uid
      });
      state.cart = []; state.isDelivery = false; showToast("Order Sent!");
    } catch(e) { showToast("Error!"); }
  };

  window.adminAuth = e => {
    e.preventDefault();
    if (document.getElementById("adminPin").value === ADMIN_CODE) { state.isAdminAuth = true; render(); }
    else showToast("Wrong Code!");
  };

  window.adminLock = () => { state.isAdminAuth = false; render(); };
  window.setStatus = (id, s) => updateDoc(doc(db,"artifacts",appId,"public","data","orders",id), { status: s });
  window.deleteOrder = id => deleteDoc(doc(db,"artifacts",appId,"public","data","orders",id));
  function showToast(m) { state.notification = m; render(); setTimeout(() => { state.notification = null; render(); }, 3000); }

  /* ================= UI ================= */

  function render() {
    const root = document.getElementById("app");
    if (!state.isLoggedIn) {
        root.innerHTML = `
        <div class="min-h-screen bg-stone-100 flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-sm rounded-3xl p-8 shadow-2xl text-center space-y-6 animate-in">
                <div class="bg-amber-600 w-20 h-20 rounded-2xl flex items-center justify-center mx-auto rotate-3 shadow-lg"><i data-lucide="coffee" class="w-10 h-10 text-white"></i></div>
                <h1 class="text-3xl font-black text-stone-900 tracking-tight italic">Mitch's Coffee</h1>
                <form onsubmit="login(event)" class="space-y-4">
                    <input required id="loginName" placeholder="What's your name?" class="w-full bg-stone-50 border-2 border-stone-100 rounded-2xl px-6 py-4 text-lg outline-none focus:border-amber-600 font-bold">
                    <button class="w-full bg-stone-900 text-white py-4 rounded-2xl font-bold text-lg shadow-xl active:scale-95 transition-transform">Start Ordering</button>
                </form>
            </div>
        </div>`;
    } else {
        root.innerHTML = `
            <header class="bg-white/80 backdrop-blur-md border-b sticky top-0 z-40 px-4 py-4 flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <div class="bg-amber-600 p-1.5 rounded-lg"><i data-lucide="coffee" class="w-5 h-5 text-white"></i></div>
                    <h1 class="text-xl font-black italic">Mitch's</h1>
                </div>
                <div class="flex gap-2">
                    <button onclick="setView('customer')" class="px-4 py-2 rounded-xl text-xs font-black uppercase ${state.view==='customer'?'bg-amber-600 text-white shadow-md':'text-stone-500'}">Menu</button>
                    <button onclick="setView('admin')" class="px-4 py-2 rounded-xl text-xs font-black uppercase flex items-center gap-2 ${state.view==='admin'?'bg-stone-900 text-white':'text-stone-500'}"><i data-lucide="chef-hat" class="w-3 h-3"></i>Admin</button>
                </div>
            </header>
            <main class="max-w-md mx-auto p-4 space-y-6">
                ${state.view === 'customer' ? renderCustomer() : renderAdmin()}
            </main>
            ${state.notification ? `<div class="fixed top-4 left-4 right-4 z-50 animate-bounce bg-stone-900 text-white px-6 py-3 rounded-2xl shadow-2xl text-center font-bold border border-white/10">${state.notification}</div>` : ''}
        `;
    }
    lucide.createIcons();
  }

  function renderCustomer() {
    const now = Date.now();
    // Search for order matching either UID or Name (as backup for session refreshes)
    const myOrder = state.orders.find(o => 
      (o.userId === state.user?.uid || o.customerName === state.customerName) && 
      o.status !== 'completed' && 
      (now - (o.timestamp?.toMillis() || now) < 3600000)
    );
    const cartTotal = state.cart.reduce((s, i) => s + (i.price * i.qty), 0) + (state.isDelivery ? 1 : 0);

    return `
        <!-- PERSONAL STATUS ONLY (NOT PUBLIC) -->
        ${myOrder ? `
            <section class="bg-white p-6 rounded-[2.5rem] shadow-xl border-4 ${myOrder.status==='ready'?'border-green-400':'border-amber-400'} space-y-5 animate-in relative overflow-hidden">
                <div class="flex justify-between items-center relative z-10">
                    <h3 class="font-black text-sm uppercase flex items-center gap-2 tracking-widest text-amber-800">
                        ${myOrder.status==='ready' ? '<i data-lucide="check-circle" class="text-green-500"></i> READY FOR PICKUP!' : '<i data-lucide="zap" class="animate-pulse text-amber-500"></i> PROGRESS'}
                    </h3>
                    <div class="flex gap-1">
                      ${myOrder.isDelivery ? '<span class="text-[8px] font-black bg-blue-600 text-white px-1.5 py-0.5 rounded">DELIVERY</span>' : ''}
                      <span class="text-[10px] font-black bg-stone-100 px-2 py-1 rounded">#${myOrder.id.slice(-4)}</span>
                    </div>
                </div>

                <!-- EXPLICIT STATUS TEXT -->
                <div class="flex justify-between items-center bg-stone-50 p-4 rounded-2xl border border-stone-100">
                    <span class="text-2xl font-black uppercase italic text-stone-900 tracking-tighter">Status: ${myOrder.status}</span>
                    <span class="text-xs font-bold text-stone-400 bg-white px-2 py-1 rounded-lg border shadow-sm">${myOrder.status==='pending'?'33%':myOrder.status==='brewing'?'66%':'100%'}</span>
                </div>
                
                <div class="relative h-5 rounded-full bg-stone-100 overflow-hidden shadow-inner ring-1 ring-black/5">
                    <div class="h-full transition-all duration-1000 ${myOrder.status==='ready'?'bg-green-500':'bg-amber-500'} ${myOrder.status==='brewing'?'pulse-amber':''}" style="width: ${myOrder.status==='pending'?'33%':myOrder.status==='brewing'?'66%':'100%'}"></div>
                </div>

                <div class="bg-stone-50 rounded-2xl p-4 space-y-3 border border-stone-100 text-xs">
                    ${myOrder.items.map(it => `
                        <div class="flex flex-col border-b border-stone-200 last:border-0 pb-2">
                            <div class="flex justify-between font-black text-stone-800 text-sm"><span>${it.qty}x ${it.name}</span><span class="text-stone-500">${it.size}</span></div>
                            ${it.syrupType!=='None'?`<span class="text-amber-600 font-black text-[9px] uppercase tracking-wider flex items-center gap-1 mt-1"><i data-lucide="droplets" class="w-3 h-3"></i>${it.syrupPumps} Pumps ${it.syrupType}</span>`:''}
                        </div>`).join('')}
                </div>

                ${myOrder.status === 'ready' ? `
                  <button onclick="setStatus('${myOrder.id}', 'completed')" class="w-full bg-green-600 text-white py-4 rounded-2xl font-black text-lg shadow-lg active:scale-95 transition-transform">
                    ${myOrder.isDelivery ? "I Got My Delivery!" : "I've Picked It Up!"}
                  </button>
                ` : `<p class="text-center text-xs font-bold text-stone-400 italic">Mitch is working on it. Hold tight!</p>`}
            </section>
        ` : ''}

        <!-- BASKET -->
        ${state.cart.length ? `
            <section class="bg-stone-900 text-white p-6 rounded-3xl shadow-2xl space-y-5 animate-in">
                <h2 class="text-xl font-black flex items-center gap-2 text-amber-400"><i data-lucide="shopping-bag" class="w-6 h-6"></i> Your Basket</h2>

                <div class="grid grid-cols-2 gap-2 bg-white/5 p-1 rounded-2xl border border-white/10">
                    <button onclick="setDelivery(false)" class="py-4 rounded-xl text-[10px] font-black uppercase transition-all flex flex-col items-center gap-1 ${!state.isDelivery ? 'bg-amber-600 text-white shadow-lg' : 'text-stone-500 hover:bg-white/5'}">
                        <i data-lucide="store" class="w-4 h-4"></i> Pickup
                    </button>
                    <button onclick="setDelivery(true)" class="py-4 rounded-xl text-[10px] font-black uppercase transition-all flex flex-col items-center gap-1 ${state.isDelivery ? 'bg-blue-600 text-white shadow-lg' : 'text-stone-500 hover:bg-white/5'}">
                        <i data-lucide="truck" class="w-4 h-4"></i> Delivery ($1)
                    </button>
                </div>

                <div class="space-y-3 px-1">
                    ${state.cart.map((item, idx) => `
                        <div class="flex items-center justify-between text-sm">
                            <div class="flex flex-col"><span class="font-bold">${item.qty}x ${item.name}</span><span class="text-[10px] text-stone-400 font-bold uppercase tracking-tighter">${item.size} ${item.syrupType!=='None'?`/ ${item.syrupPumps} Pumps ${item.syrupType}`:''}</span></div>
                            <div class="flex items-center gap-3">
                                <button onclick="removeCart(${idx})" class="p-1 text-stone-500 hover:text-white transition-colors"><i data-lucide="minus" class="w-4 h-4"></i></button>
                                <span class="font-bold text-amber-400">$${(item.price*item.qty).toFixed(2)}</span>
                            </div>
                        </div>`).join('')}
                    ${state.isDelivery ? `<div class="flex justify-between text-[10px] text-blue-400 font-black uppercase tracking-widest border-t border-white/10 pt-3"><span>Delivery Fee</span><span>$1.00</span></div>` : ''}
                </div>
                <div class="space-y-3 pt-2">
                    <input id="roomInput" value="${state.dormRoom}" placeholder="Enter Dorm Room #" class="w-full bg-white/10 border-none rounded-2xl px-5 py-4 text-white outline-none placeholder:text-stone-600 font-black">
                    <button onclick="order()" class="w-full bg-amber-600 text-white py-4 rounded-2xl font-black text-xl shadow-lg active:scale-95 transition-transform">Place Order • $${cartTotal.toFixed(2)}</button>
                </div>
            </section>
        ` : ''}

        <!-- CUSTOMIZE -->
        <section class="bg-white p-4 rounded-3xl border shadow-sm space-y-4">
            <div class="flex items-center gap-2 text-stone-400 font-bold text-xs uppercase px-1"><i data-lucide="droplets" class="w-3 h-3"></i> Customize Syrup</div>
            <div class="bg-stone-50 p-1 rounded-xl flex gap-1">
                <button onclick="setSize('Small')" class="flex-1 py-2 rounded-lg text-xs font-black transition-all ${state.selectedSize==='Small'?'bg-white text-amber-600 shadow-sm':'text-stone-400'}">Small ($5)</button>
                <button onclick="setSize('Large')" class="flex-1 py-2 rounded-lg text-xs font-black transition-all ${state.selectedSize==='Large'?'bg-white text-amber-600 shadow-sm':'text-stone-400'}">Large ($6)</button>
            </div>
            <div class="grid grid-cols-3 gap-2">
                ${['None', 'Vanilla', 'Classic'].map(t => `<button onclick="setSyrup('${t}')" class="py-2 rounded-xl text-[10px] font-black border-2 transition-all ${state.syrupType===t?'bg-amber-50 border-amber-600 text-amber-700':'bg-white border-stone-100 text-stone-400'}">${t==='None'?'No Syrup':t+' Syrup'}</button>`).join('')}
            </div>
            ${state.syrupType!=='None' ? `<div class="flex items-center justify-between bg-stone-50 p-3 rounded-xl"><span class="text-xs font-bold text-stone-500 uppercase tracking-tight">Syrup Pumps</span><div class="flex items-center gap-4"><button onclick="changePumps(-1)" class="bg-white p-1 rounded-lg border border-stone-100 shadow-sm"><i data-lucide="minus" class="w-4 h-4 text-stone-400"></i></button><span class="font-black text-amber-700 w-4 text-center">${state.syrupPumps}</span><button onclick="changePumps(1)" class="bg-white p-1 rounded-lg border border-stone-100 shadow-sm"><i data-lucide="plus" class="w-4 h-4 text-stone-400"></i></button></div></div>` : ''}
        </section>

        <!-- MENU -->
        ${CATEGORIES.map(cat => `
            <section class="space-y-4">
                <h2 class="text-xl font-black border-b-2 pb-2 uppercase tracking-tight italic text-stone-900">${cat}</h2>
                <div class="grid gap-3">
                    ${MENU_ITEMS.filter(i => i.category === cat).map(item => `
                        <div class="bg-white rounded-[2rem] border shadow-sm p-5 flex justify-between items-center active:scale-[0.98] transition hover:border-amber-500">
                            <div class="flex-1">
                                <h3 class="font-black text-stone-800 text-lg">${item.name}</h3>
                                <div class="flex gap-2 mt-1">
                                    <span class="text-amber-700 font-black bg-amber-50 px-3 py-1 rounded-full text-xs">
                                        ${item.type==='drink' ? `${state.selectedSize} • $${state.selectedSize==='Small'?'5.00':'6.00'}` : '$1.00'}
                                    </span>
                                </div>
                            </div>
                            <button onclick="add('${item.id}')" class="bg-stone-900 text-white p-4 rounded-2xl shadow-xl hover:bg-amber-600 transition-colors">
                                <i data-lucide="plus" class="w-6 h-6"></i>
                            </button>
                        </div>`).join('')}
                </div>
            </section>
        `).join('')}
    `;
  }

  function renderAdmin() {
    if(!state.isAdminAuth) {
        return `
            <div class="bg-white p-8 rounded-3xl border shadow-2xl text-center space-y-6 animate-in">
                <div class="bg-stone-100 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto border-2 border-stone-200"><i data-lucide="lock" class="text-stone-400"></i></div>
                <div><h1 class="text-2xl font-black italic">Mitch Only</h1><p class="text-stone-500 text-sm">Enter pin to see orders</p></div>
                <form onsubmit="adminAuth(event)" class="space-y-4">
                    <input type="password" id="adminPin" placeholder="PIN" class="w-full bg-stone-50 border-2 rounded-2xl px-4 py-4 text-center text-2xl font-black tracking-[1em] outline-none focus:border-stone-900">
                    <button class="w-full bg-stone-900 text-white py-4 rounded-2xl font-bold text-lg shadow-xl">Open Queue</button>
                </form>
            </div>`;
    }
    return `
        <div class="flex justify-between items-center bg-stone-900 text-white p-4 rounded-2xl shadow-lg">
            <h2 class="text-xl font-black italic">Mitch's Master Queue</h2>
            <button onclick="adminLock()" class="text-[10px] font-bold border border-white/20 px-3 py-1 rounded-lg uppercase">Lock</button>
        </div>
        ${state.orders.length === 0 ? '<p class="text-center py-20 text-stone-400 font-bold italic">No orders yet, Mitch!</p>' : ''}
        ${state.orders.map(o => `
            <div class="bg-white p-6 rounded-[2.5rem] border-2 shadow-sm transition-all ${o.status==='completed'?'opacity-40 border-stone-100':'border-amber-500 shadow-lg'}">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="font-black text-2xl">${o.customerName}</h3>
                        <span class="bg-amber-100 text-amber-800 text-xs font-black px-2 py-1 rounded uppercase tracking-tighter">Room ${o.dormRoom}</span>
                        ${o.isDelivery ? '<span class="bg-blue-600 text-white text-[9px] font-black px-2 py-1 rounded uppercase ml-1">DELIVERY</span>' : ''}
                    </div>
                    <div class="flex flex-col items-end gap-2">
                       <span class="text-[10px] px-3 py-1.5 rounded-full uppercase font-black bg-stone-100">${o.status}</span>
                       <button onclick="deleteOrder('${o.id}')" class="text-stone-300 hover:text-red-500 p-1 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                </div>
                <div class="space-y-2 mb-6 text-sm">
                    ${o.items.map(it => `
                        <div class="bg-stone-50 p-3 rounded-2xl border border-stone-100 flex justify-between items-center">
                            <span class="font-black text-stone-800">${it.qty}x ${it.name} (${it.size})</span>
                            ${it.syrupType!=='None'?`<span class="text-amber-600 text-[10px] font-black uppercase ring-1 ring-amber-100 px-1 rounded">${it.syrupPumps} ${it.syrupType}</span>`:''}
                        </div>`).join('')}
                    <div class="flex justify-between items-center pt-2 px-2 border-t mt-1 font-black"><span>Total Amount</span><span>$${o.total?.toFixed(2)}</span></div>
                </div>
                <div class="flex flex-col gap-2">
                    ${o.status === 'pending' ? `<button onclick="setStatus('${o.id}', 'brewing')" class="w-full bg-amber-600 text-white py-4 rounded-2xl font-black text-lg active:scale-95 transition-transform">Start Brewing</button>` : ''}
                    ${o.status === 'brewing' ? `<button onclick="setStatus('${o.id}', 'ready')" class="w-full bg-green-600 text-white py-4 rounded-2xl font-black text-lg active:scale-95 transition-transform">Ready for ${o.isDelivery ? 'Delivery' : 'Pickup'}</button>` : ''}
                    ${o.status === 'ready' ? `<button onclick="setStatus('${o.id}', 'completed')" class="w-full bg-stone-900 text-white py-4 rounded-2xl font-black text-lg active:scale-95 transition-transform">Mark Completed</button>` : ''}
                </div>
            </div>`).join('')}
    `;
  }

  init();
</script>
</body>
</html>

